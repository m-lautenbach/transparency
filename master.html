<!doctype html>
<html>
  <head>
    <title>transparency master</title>
  </head>
  <script src="/js/socket.io.min.js"></script>
  <script src="/js/rx.all.min.js"></script>
  <script src="/js/lodash.min.js"></script>
  <script>
    var accumulate = function(list, item) {
        return list.concat([item])
    }
    var socket = io('/master')

    var initialList = Rx.Observable
        .fromEvent(socket, 'client list')
    var connections = Rx.Observable
        .fromEvent(socket, 'client connected')
        .scan(accumulate, [])
        .merge(
            Rx.Observable.from([[]])
        )
    var disconnections = Rx.Observable
        .fromEvent(socket, 'client disconnected')
        .scan(accumulate, [])
        .merge(
            Rx.Observable.from([[]])
        )

    Rx.Observable
        .combineLatest(
            initialList,
            connections,
            disconnections,
            function(initialList, connections, disconnections) {
                return _.differenceWith(
                    _.reject(initialList, (client) => client.self).concat(connections),
                    disconnections,
                    function(connection, disconnection) {
                        return connection.socketId === disconnection
                    }
                )
            }
        )
        .subscribe(
            function(connectedClients) {
                console.log('connectedClients: ', connectedClients)
            }
        )


  </script>
  <body>
  </body>
</html>
